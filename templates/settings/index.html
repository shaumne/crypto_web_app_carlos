{% extends "base.html" %}

{% block title %}Settings - Crypto Trading Platform{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Page Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <h2 class="h3 mb-0 text-primary">
                    <i class="fas fa-cog me-2"></i>Settings
                </h2>
                <div class="d-flex gap-2">
                    <button class="btn btn-success" onclick="saveAllSettings()">
                        <i class="fas fa-save me-1"></i>Save All
                    </button>
                    <button class="btn btn-outline-secondary" onclick="resetSettings()">
                        <i class="fas fa-undo me-1"></i>Reset to Defaults
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Tabs -->
    <div class="card border-0 shadow-sm">
        <div class="card-header bg-white border-bottom-0">
            <ul class="nav nav-tabs card-header-tabs" id="settingsTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="trading-tab" data-bs-toggle="tab" data-bs-target="#trading-pane" type="button" role="tab">
                        <i class="fas fa-chart-line me-1"></i>Trading
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="api-tab" data-bs-toggle="tab" data-bs-target="#api-pane" type="button" role="tab">
                        <i class="fas fa-plug me-1"></i>API Configuration
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="security-tab" data-bs-toggle="tab" data-bs-target="#security-pane" type="button" role="tab">
                        <i class="fas fa-shield-alt me-1"></i>Security
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="notifications-tab" data-bs-toggle="tab" data-bs-target="#notifications-pane" type="button" role="tab">
                        <i class="fas fa-bell me-1"></i>Notifications
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="system-tab" data-bs-toggle="tab" data-bs-target="#system-pane" type="button" role="tab">
                        <i class="fas fa-server me-1"></i>System
                    </button>
                </li>
            </ul>
        </div>
        <div class="card-body">
            <div class="tab-content" id="settingsTabsContent">
                <!-- Trading Settings Tab -->
                <div class="tab-pane fade show active" id="trading-pane" role="tabpanel">
                    <form id="tradingSettingsForm">
                        <div class="row">
                            <div class="col-lg-6">
                                <h5 class="mb-3">Trading Parameters</h5>
                                
                                <div class="mb-3">
                                    <label class="form-label">Default Trade Amount ($)</label>
                                    <input type="number" class="form-control" id="defaultTradeAmount" step="0.01" min="1" value="10.00">
                                    <div class="form-text">Default amount for each trade when using automated signals</div>
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label">Maximum Position Size ($)</label>
                                    <input type="number" class="form-control" id="maxPositionSize" step="0.01" min="1" value="100.00">
                                    <div class="form-text">Maximum amount that can be invested in a single position</div>
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label">Maximum Open Positions</label>
                                    <input type="number" class="form-control" id="maxOpenPositions" min="1" max="50" value="10">
                                    <div class="form-text">Maximum number of positions that can be open simultaneously</div>
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label">Default Take Profit (%)</label>
                                    <input type="number" class="form-control" id="defaultTakeProfit" step="0.1" min="0.1" value="5.0">
                                    <div class="form-text">Default take profit percentage for new positions</div>
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label">Default Stop Loss (%)</label>
                                    <input type="number" class="form-control" id="defaultStopLoss" step="0.1" min="0.1" value="2.0">
                                    <div class="form-text">Default stop loss percentage for new positions</div>
                                </div>
                            </div>
                            
                            <div class="col-lg-6">
                                <h5 class="mb-3">Technical Analysis</h5>
                                
                                <div class="mb-3">
                                    <label class="form-label">RSI Oversold Threshold</label>
                                    <input type="number" class="form-control" id="rsiOversold" min="10" max="40" value="30">
                                    <div class="form-text">RSI level below which the asset is considered oversold</div>
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label">RSI Overbought Threshold</label>
                                    <input type="number" class="form-control" id="rsiOverbought" min="60" max="90" value="70">
                                    <div class="form-text">RSI level above which the asset is considered overbought</div>
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label">ATR Multiplier</label>
                                    <input type="number" class="form-control" id="atrMultiplier" step="0.1" min="1.0" max="5.0" value="2.0">
                                    <div class="form-text">Multiplier for ATR-based stop loss calculations</div>
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label">Volume Threshold</label>
                                    <input type="number" class="form-control" id="volumeThreshold" step="0.1" min="1.0" value="1.5">
                                    <div class="form-text">Minimum volume ratio for considering trading signals</div>
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label">Analysis Interval (seconds)</label>
                                    <input type="number" class="form-control" id="analysisInterval" min="10" max="300" value="30">
                                    <div class="form-text">How often to run technical analysis on all coins</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row mt-4">
                            <div class="col-12">
                                <h5 class="mb-3">Automated Trading</h5>
                                
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-check form-switch mb-3">
                                            <input class="form-check-input" type="checkbox" id="enableAutoTrading">
                                            <label class="form-check-label" for="enableAutoTrading">
                                                <strong>Enable Automated Trading</strong>
                                            </label>
                                            <div class="form-text">Allow the system to automatically execute trades based on signals</div>
                                        </div>
                                        
                                        <div class="form-check form-switch mb-3">
                                            <input class="form-check-input" type="checkbox" id="enableTpSlMonitoring" checked>
                                            <label class="form-check-label" for="enableTpSlMonitoring">
                                                <strong>Enable TP/SL Monitoring</strong>
                                            </label>
                                            <div class="form-text">Monitor positions for take profit and stop loss triggers</div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-check form-switch mb-3">
                                            <input class="form-check-input" type="checkbox" id="enableRiskManagement" checked>
                                            <label class="form-check-label" for="enableRiskManagement">
                                                <strong>Enable Risk Management</strong>
                                            </label>
                                            <div class="form-text">Apply position sizing and risk management rules</div>
                                        </div>
                                        
                                        <div class="form-check form-switch mb-3">
                                            <input class="form-check-input" type="checkbox" id="enableSignalGeneration" checked>
                                            <label class="form-check-label" for="enableSignalGeneration">
                                                <strong>Enable Signal Generation</strong>
                                            </label>
                                            <div class="form-text">Generate buy/sell signals based on technical analysis</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>

                <!-- API Configuration Tab -->
                <div class="tab-pane fade" id="api-pane" role="tabpanel">
                    <form id="apiSettingsForm">
                        <div class="row">
                            <div class="col-lg-6">
                                <h5 class="mb-3">Crypto.com Exchange API</h5>
                                
                                <div class="alert alert-info">
                                    <i class="fas fa-info-circle me-2"></i>
                                    <strong>Note:</strong> API credentials are required for live trading. Leave empty to use sandbox mode.
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label">API Key</label>
                                    <input type="text" class="form-control" id="apiKey" placeholder="Enter your API key">
                                    <div class="form-text">Your Crypto.com Exchange API key</div>
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label">API Secret</label>
                                    <input type="password" class="form-control" id="apiSecret" placeholder="Enter your API secret">
                                    <div class="form-text">Your Crypto.com Exchange API secret</div>
                                </div>
                                
                                <div class="form-check form-switch mb-3">
                                    <input class="form-check-input" type="checkbox" id="sandboxMode" checked>
                                    <label class="form-check-label" for="sandboxMode">
                                        <strong>Sandbox Mode</strong>
                                    </label>
                                    <div class="form-text">Use sandbox environment for testing (recommended for development)</div>
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label">API Rate Limit (requests/minute)</label>
                                    <input type="number" class="form-control" id="apiRateLimit" min="1" max="100" value="60">
                                    <div class="form-text">Maximum number of API requests per minute</div>
                                </div>
                            </div>
                            
                            <div class="col-lg-6">
                                <h5 class="mb-3">API Testing</h5>
                                
                                <div class="card bg-light">
                                    <div class="card-body">
                                        <h6>Connection Status</h6>
                                        <div id="apiStatus" class="mb-3">
                                            <span class="badge bg-secondary">Not Tested</span>
                                        </div>
                                        
                                        <button type="button" class="btn btn-primary mb-3" onclick="testApiConnection()">
                                            <i class="fas fa-plug me-1"></i>Test Connection
                                        </button>
                                        
                                        <h6>Account Information</h6>
                                        <div id="accountInfo">
                                            <p class="text-muted">Click "Test Connection" to retrieve account information</p>
                                        </div>
                                    </div>
                                </div>
                                
                                <h5 class="mb-3 mt-4">Advanced Settings</h5>
                                
                                <div class="mb-3">
                                    <label class="form-label">Request Timeout (seconds)</label>
                                    <input type="number" class="form-control" id="requestTimeout" min="5" max="60" value="30">
                                    <div class="form-text">Timeout for API requests</div>
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label">Retry Attempts</label>
                                    <input type="number" class="form-control" id="retryAttempts" min="1" max="5" value="3">
                                    <div class="form-text">Number of retry attempts for failed requests</div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>

                <!-- Security Tab -->
                <div class="tab-pane fade" id="security-pane" role="tabpanel">
                    <div class="row">
                        <div class="col-lg-6">
                            <h5 class="mb-3">Password Management</h5>
                            
                            <form id="passwordChangeForm">
                                <div class="mb-3">
                                    <label class="form-label">Current Password</label>
                                    <input type="password" class="form-control" id="currentPassword" required>
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label">New Password</label>
                                    <input type="password" class="form-control" id="newPassword" required>
                                    <div class="form-text">Password must be at least 8 characters long</div>
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label">Confirm New Password</label>
                                    <input type="password" class="form-control" id="confirmPassword" required>
                                </div>
                                
                                <button type="submit" class="btn btn-warning">
                                    <i class="fas fa-key me-1"></i>Change Password
                                </button>
                            </form>
                        </div>
                        
                        <div class="col-lg-6">
                            <h5 class="mb-3">Security Settings</h5>
                            
                            <div class="form-check form-switch mb-3">
                                <input class="form-check-input" type="checkbox" id="enableSessionTimeout" checked>
                                <label class="form-check-label" for="enableSessionTimeout">
                                    <strong>Auto Logout</strong>
                                </label>
                                <div class="form-text">Automatically logout after period of inactivity</div>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">Session Timeout (minutes)</label>
                                <input type="number" class="form-control" id="sessionTimeout" min="5" max="1440" value="60">
                                <div class="form-text">Minutes of inactivity before automatic logout</div>
                            </div>
                            
                            <div class="form-check form-switch mb-3">
                                <input class="form-check-input" type="checkbox" id="enableAuditLogging" checked>
                                <label class="form-check-label" for="enableAuditLogging">
                                    <strong>Audit Logging</strong>
                                </label>
                                <div class="form-text">Log all trading activities and system events</div>
                            </div>
                            
                            <h5 class="mb-3 mt-4">Data Management</h5>
                            
                            <div class="mb-3">
                                <label class="form-label">Data Retention (days)</label>
                                <input type="number" class="form-control" id="dataRetention" min="30" max="3650" value="365">
                                <div class="form-text">How long to keep historical data</div>
                            </div>
                            
                            <button type="button" class="btn btn-outline-danger" onclick="showDataExportModal()">
                                <i class="fas fa-download me-1"></i>Export All Data
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Notifications Tab -->
                <div class="tab-pane fade" id="notifications-pane" role="tabpanel">
                    <div class="row">
                        <div class="col-lg-6">
                            <h5 class="mb-3">Email Notifications</h5>
                            
                            <div class="mb-3">
                                <label class="form-label">Email Address</label>
                                <input type="email" class="form-control" id="emailAddress" placeholder="your@email.com">
                                <div class="form-text">Email address for notifications</div>
                            </div>
                            
                            <div class="form-check form-switch mb-3">
                                <input class="form-check-input" type="checkbox" id="emailTradeAlerts">
                                <label class="form-check-label" for="emailTradeAlerts">
                                    <strong>Trade Alerts</strong>
                                </label>
                                <div class="form-text">Notify when trades are executed</div>
                            </div>
                            
                            <div class="form-check form-switch mb-3">
                                <input class="form-check-input" type="checkbox" id="emailPositionUpdates">
                                <label class="form-check-label" for="emailPositionUpdates">
                                    <strong>Position Updates</strong>
                                </label>
                                <div class="form-text">Notify when positions reach TP/SL</div>
                            </div>
                            
                            <div class="form-check form-switch mb-3">
                                <input class="form-check-input" type="checkbox" id="emailSystemAlerts">
                                <label class="form-check-label" for="emailSystemAlerts">
                                    <strong>System Alerts</strong>
                                </label>
                                <div class="form-text">Notify of system errors or issues</div>
                            </div>
                        </div>
                        
                        <div class="col-lg-6">
                            <h5 class="mb-3">Telegram Notifications</h5>
                            
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle me-2"></i>
                                <strong>Setup:</strong> Create a Telegram bot and get your chat ID to receive notifications.
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">Bot Token</label>
                                <input type="text" class="form-control" id="telegramBotToken" placeholder="123456789:ABCDEF...">
                                <div class="form-text">Telegram bot token from @BotFather</div>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">Chat ID</label>
                                <input type="text" class="form-control" id="telegramChatId" placeholder="123456789">
                                <div class="form-text">Your Telegram chat ID</div>
                            </div>
                            
                            <button type="button" class="btn btn-primary mb-3" onclick="testTelegramNotification()">
                                <i class="fab fa-telegram me-1"></i>Test Notification
                            </button>
                            
                            <div class="form-check form-switch mb-3">
                                <input class="form-check-input" type="checkbox" id="telegramTradeAlerts">
                                <label class="form-check-label" for="telegramTradeAlerts">
                                    <strong>Trade Alerts</strong>
                                </label>
                            </div>
                            
                            <div class="form-check form-switch mb-3">
                                <input class="form-check-input" type="checkbox" id="telegramPositionUpdates">
                                <label class="form-check-label" for="telegramPositionUpdates">
                                    <strong>Position Updates</strong>
                                </label>
                            </div>
                            
                            <div class="form-check form-switch mb-3">
                                <input class="form-check-input" type="checkbox" id="telegramSystemAlerts">
                                <label class="form-check-label" for="telegramSystemAlerts">
                                    <strong>System Alerts</strong>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- System Tab -->
                <div class="tab-pane fade" id="system-pane" role="tabpanel">
                    <div class="row">
                        <div class="col-lg-6">
                            <h5 class="mb-3">System Information</h5>
                            
                            <div class="table-responsive">
                                <table class="table table-sm">
                                    <tbody>
                                        <tr>
                                            <td>Application Version:</td>
                                            <td class="fw-bold">v1.0.0</td>
                                        </tr>
                                        <tr>
                                            <td>Database Version:</td>
                                            <td class="fw-bold" id="dbVersion">Loading...</td>
                                        </tr>
                                        <tr>
                                            <td>Python Version:</td>
                                            <td class="fw-bold" id="pythonVersion">Loading...</td>
                                        </tr>
                                        <tr>
                                            <td>Uptime:</td>
                                            <td class="fw-bold" id="systemUptime">Loading...</td>
                                        </tr>
                                        <tr>
                                            <td>Last Backup:</td>
                                            <td class="fw-bold" id="lastBackup">Never</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            
                            <h5 class="mb-3 mt-4">System Health</h5>
                            
                            <div class="mb-3">
                                <div class="d-flex justify-content-between mb-1">
                                    <span>API Connection</span>
                                    <span class="badge bg-success" id="apiHealth">Healthy</span>
                                </div>
                                
                                <div class="d-flex justify-content-between mb-1">
                                    <span>Database</span>
                                    <span class="badge bg-success" id="dbHealth">Healthy</span>
                                </div>
                                
                                <div class="d-flex justify-content-between mb-1">
                                    <span>Trading Monitor</span>
                                    <span class="badge bg-success" id="tradingMonitorHealth">Running</span>
                                </div>
                                
                                <div class="d-flex justify-content-between mb-1">
                                    <span>TP/SL Monitor</span>
                                    <span class="badge bg-success" id="tpSlMonitorHealth">Running</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-lg-6">
                            <h5 class="mb-3">Maintenance</h5>
                            
                            <div class="d-grid gap-2">
                                <button type="button" class="btn btn-outline-primary" onclick="createBackup()">
                                    <i class="fas fa-save me-1"></i>Create Database Backup
                                </button>
                                
                                <button type="button" class="btn btn-outline-info" onclick="optimizeDatabase()">
                                    <i class="fas fa-database me-1"></i>Optimize Database
                                </button>
                                
                                <button type="button" class="btn btn-outline-warning" onclick="clearCache()">
                                    <i class="fas fa-broom me-1"></i>Clear Cache
                                </button>
                                
                                <button type="button" class="btn btn-outline-danger" onclick="showResetModal()">
                                    <i class="fas fa-exclamation-triangle me-1"></i>Reset All Data
                                </button>
                            </div>
                            
                            <h5 class="mb-3 mt-4">Logging</h5>
                            
                            <div class="mb-3">
                                <label class="form-label">Log Level</label>
                                <select class="form-select" id="logLevel">
                                    <option value="DEBUG">DEBUG</option>
                                    <option value="INFO" selected>INFO</option>
                                    <option value="WARNING">WARNING</option>
                                    <option value="ERROR">ERROR</option>
                                </select>
                            </div>
                            
                            <div class="form-check form-switch mb-3">
                                <input class="form-check-input" type="checkbox" id="enableFileLogging" checked>
                                <label class="form-check-label" for="enableFileLogging">
                                    <strong>File Logging</strong>
                                </label>
                                <div class="form-text">Save logs to files</div>
                            </div>
                            
                            <button type="button" class="btn btn-outline-secondary" onclick="downloadLogs()">
                                <i class="fas fa-download me-1"></i>Download Logs
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Data Export Modal -->
<div class="modal fade" id="dataExportModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Export Data</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Select the data you want to export:</p>
                
                <div class="form-check mb-2">
                    <input class="form-check-input" type="checkbox" id="exportTrades" checked>
                    <label class="form-check-label" for="exportTrades">Trading History</label>
                </div>
                
                <div class="form-check mb-2">
                    <input class="form-check-input" type="checkbox" id="exportPositions" checked>
                    <label class="form-check-label" for="exportPositions">Positions</label>
                </div>
                
                <div class="form-check mb-2">
                    <input class="form-check-input" type="checkbox" id="exportOrders" checked>
                    <label class="form-check-label" for="exportOrders">Orders</label>
                </div>
                
                <div class="form-check mb-2">
                    <input class="form-check-input" type="checkbox" id="exportAnalysis">
                    <label class="form-check-label" for="exportAnalysis">Technical Analysis</label>
                </div>
                
                <div class="form-check mb-2">
                    <input class="form-check-input" type="checkbox" id="exportLogs">
                    <label class="form-check-label" for="exportLogs">System Logs</label>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="exportData()">Export</button>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    loadSettings();
    loadSystemInfo();
    
    // Form submissions
    document.getElementById('passwordChangeForm').addEventListener('submit', function(e) {
        e.preventDefault();
        changePassword();
    });
    
    // Auto-save settings on change
    document.querySelectorAll('#tradingSettingsForm input, #tradingSettingsForm select').forEach(input => {
        input.addEventListener('change', function() {
            if (this.type === 'checkbox') {
                saveSetting(this.id, this.checked);
            } else {
                saveSetting(this.id, this.value);
            }
        });
    });
});

function loadSettings() {
    fetch('/api/settings')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                populateSettings(data.settings);
            }
        })
        .catch(error => console.error('Error loading settings:', error));
}

function populateSettings(settings) {
    // Trading settings
    document.getElementById('defaultTradeAmount').value = settings.default_trade_amount || 10.00;
    document.getElementById('maxPositionSize').value = settings.max_position_size || 100.00;
    document.getElementById('maxOpenPositions').value = settings.max_open_positions || 10;
    document.getElementById('defaultTakeProfit').value = settings.default_take_profit || 5.0;
    document.getElementById('defaultStopLoss').value = settings.default_stop_loss || 2.0;
    document.getElementById('rsiOversold').value = settings.rsi_oversold || 30;
    document.getElementById('rsiOverbought').value = settings.rsi_overbought || 70;
    document.getElementById('atrMultiplier').value = settings.atr_multiplier || 2.0;
    document.getElementById('volumeThreshold').value = settings.volume_threshold || 1.5;
    document.getElementById('analysisInterval').value = settings.analysis_interval || 30;
    
    // Boolean settings
    document.getElementById('enableAutoTrading').checked = settings.enable_auto_trading || false;
    document.getElementById('enableTpSlMonitoring').checked = settings.enable_tp_sl_monitoring !== false;
    document.getElementById('enableRiskManagement').checked = settings.enable_risk_management !== false;
    document.getElementById('enableSignalGeneration').checked = settings.enable_signal_generation !== false;
    
    // API settings
    document.getElementById('apiKey').value = settings.api_key || '';
    document.getElementById('apiSecret').value = settings.api_secret || '';
    document.getElementById('sandboxMode').checked = settings.sandbox_mode !== false;
    document.getElementById('apiRateLimit').value = settings.api_rate_limit || 60;
    document.getElementById('requestTimeout').value = settings.request_timeout || 30;
    document.getElementById('retryAttempts').value = settings.retry_attempts || 3;
    
    // Security settings
    document.getElementById('enableSessionTimeout').checked = settings.enable_session_timeout !== false;
    document.getElementById('sessionTimeout').value = settings.session_timeout || 60;
    document.getElementById('enableAuditLogging').checked = settings.enable_audit_logging !== false;
    document.getElementById('dataRetention').value = settings.data_retention || 365;
    
    // Notification settings
    document.getElementById('emailAddress').value = settings.email_address || '';
    document.getElementById('emailTradeAlerts').checked = settings.email_trade_alerts || false;
    document.getElementById('emailPositionUpdates').checked = settings.email_position_updates || false;
    document.getElementById('emailSystemAlerts').checked = settings.email_system_alerts || false;
    document.getElementById('telegramBotToken').value = settings.telegram_bot_token || '';
    document.getElementById('telegramChatId').value = settings.telegram_chat_id || '';
    document.getElementById('telegramTradeAlerts').checked = settings.telegram_trade_alerts || false;
    document.getElementById('telegramPositionUpdates').checked = settings.telegram_position_updates || false;
    document.getElementById('telegramSystemAlerts').checked = settings.telegram_system_alerts || false;
    
    // System settings
    document.getElementById('logLevel').value = settings.log_level || 'INFO';
    document.getElementById('enableFileLogging').checked = settings.enable_file_logging !== false;
}

function saveSetting(key, value) {
    fetch('/api/settings/update', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ [key]: value })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert(`Setting ${key} updated`, 'success');
        } else {
            showAlert(`Error updating ${key}: ${data.message}`, 'danger');
        }
    })
    .catch(error => {
        console.error('Error saving setting:', error);
        showAlert('Error saving setting', 'danger');
    });
}

function saveAllSettings() {
    const settings = {};
    
    // Collect all form values
    document.querySelectorAll('#tradingSettingsForm input, #tradingSettingsForm select').forEach(input => {
        if (input.type === 'checkbox') {
            settings[input.id] = input.checked;
        } else {
            settings[input.id] = input.value;
        }
    });
    
    fetch('/api/settings/update', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(settings)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('All settings saved successfully', 'success');
        } else {
            showAlert('Error saving settings: ' + data.message, 'danger');
        }
    })
    .catch(error => {
        console.error('Error saving settings:', error);
        showAlert('Error saving settings', 'danger');
    });
}

function resetSettings() {
    if (confirm('Are you sure you want to reset all settings to defaults? This cannot be undone.')) {
        fetch('/api/settings/reset', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showAlert('Settings reset to defaults', 'success');
                loadSettings();
            } else {
                showAlert('Error resetting settings: ' + data.message, 'danger');
            }
        })
        .catch(error => {
            console.error('Error resetting settings:', error);
            showAlert('Error resetting settings', 'danger');
        });
    }
}

function testApiConnection() {
    const btn = event.target;
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Testing...';
    
    fetch('/api/settings/test-api', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            document.getElementById('apiStatus').innerHTML = '<span class="badge bg-success">Connected</span>';
            document.getElementById('accountInfo').innerHTML = `
                <div class="table-responsive">
                    <table class="table table-sm">
                        <tr><td>Account ID:</td><td>${data.account_info.id || 'N/A'}</td></tr>
                        <tr><td>Balance:</td><td>${data.account_info.balance || 'N/A'}</td></tr>
                        <tr><td>Status:</td><td>${data.account_info.status || 'N/A'}</td></tr>
                    </table>
                </div>
            `;
            showAlert('API connection successful', 'success');
        } else {
            document.getElementById('apiStatus').innerHTML = '<span class="badge bg-danger">Failed</span>';
            document.getElementById('accountInfo').innerHTML = `<p class="text-danger">Error: ${data.message}</p>`;
            showAlert('API connection failed: ' + data.message, 'danger');
        }
    })
    .catch(error => {
        console.error('Error testing API:', error);
        document.getElementById('apiStatus').innerHTML = '<span class="badge bg-danger">Error</span>';
        showAlert('Error testing API connection', 'danger');
    })
    .finally(() => {
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-plug me-1"></i>Test Connection';
    });
}

function changePassword() {
    const currentPassword = document.getElementById('currentPassword').value;
    const newPassword = document.getElementById('newPassword').value;
    const confirmPassword = document.getElementById('confirmPassword').value;
    
    if (newPassword !== confirmPassword) {
        showAlert('New passwords do not match', 'danger');
        return;
    }
    
    if (newPassword.length < 8) {
        showAlert('Password must be at least 8 characters long', 'danger');
        return;
    }
    
    fetch('/api/auth/change-password', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            current_password: currentPassword,
            new_password: newPassword
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('Password changed successfully', 'success');
            document.getElementById('passwordChangeForm').reset();
        } else {
            showAlert('Error changing password: ' + data.message, 'danger');
        }
    })
    .catch(error => {
        console.error('Error changing password:', error);
        showAlert('Error changing password', 'danger');
    });
}

function loadSystemInfo() {
    fetch('/api/system/info')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.getElementById('dbVersion').textContent = data.db_version || 'Unknown';
                document.getElementById('pythonVersion').textContent = data.python_version || 'Unknown';
                document.getElementById('systemUptime').textContent = data.uptime || 'Unknown';
                document.getElementById('lastBackup').textContent = data.last_backup || 'Never';
                
                // Update health status
                updateHealthStatus(data.health || {});
            }
        })
        .catch(error => console.error('Error loading system info:', error));
}

function updateHealthStatus(health) {
    const healthElements = {
        'apiHealth': health.api || 'unknown',
        'dbHealth': health.database || 'unknown',
        'tradingMonitorHealth': health.trading_monitor || 'unknown',
        'tpSlMonitorHealth': health.tp_sl_monitor || 'unknown'
    };
    
    Object.entries(healthElements).forEach(([elementId, status]) => {
        const element = document.getElementById(elementId);
        element.className = `badge bg-${getHealthBadgeColor(status)}`;
        element.textContent = status.charAt(0).toUpperCase() + status.slice(1);
    });
}

function getHealthBadgeColor(status) {
    switch(status.toLowerCase()) {
        case 'healthy':
        case 'running':
        case 'connected': return 'success';
        case 'warning': return 'warning';
        case 'error':
        case 'failed':
        case 'stopped': return 'danger';
        default: return 'secondary';
    }
}

function testTelegramNotification() {
    fetch('/api/settings/test-telegram', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('Telegram test notification sent successfully', 'success');
        } else {
            showAlert('Error sending Telegram notification: ' + data.message, 'danger');
        }
    })
    .catch(error => {
        console.error('Error testing Telegram:', error);
        showAlert('Error testing Telegram notification', 'danger');
    });
}

function showDataExportModal() {
    new bootstrap.Modal(document.getElementById('dataExportModal')).show();
}

function exportData() {
    const exportOptions = {
        trades: document.getElementById('exportTrades').checked,
        positions: document.getElementById('exportPositions').checked,
        orders: document.getElementById('exportOrders').checked,
        analysis: document.getElementById('exportAnalysis').checked,
        logs: document.getElementById('exportLogs').checked
    };
    
    const queryString = new URLSearchParams(exportOptions).toString();
    window.open(`/api/system/export-data?${queryString}`, '_blank');
    
    bootstrap.Modal.getInstance(document.getElementById('dataExportModal')).hide();
}

function createBackup() {
    fetch('/api/system/backup', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('Database backup created successfully', 'success');
            loadSystemInfo();
        } else {
            showAlert('Error creating backup: ' + data.message, 'danger');
        }
    })
    .catch(error => {
        console.error('Error creating backup:', error);
        showAlert('Error creating backup', 'danger');
    });
}

function optimizeDatabase() {
    fetch('/api/system/optimize', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('Database optimized successfully', 'success');
        } else {
            showAlert('Error optimizing database: ' + data.message, 'danger');
        }
    })
    .catch(error => {
        console.error('Error optimizing database:', error);
        showAlert('Error optimizing database', 'danger');
    });
}

function clearCache() {
    fetch('/api/system/clear-cache', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('Cache cleared successfully', 'success');
        } else {
            showAlert('Error clearing cache: ' + data.message, 'danger');
        }
    })
    .catch(error => {
        console.error('Error clearing cache:', error);
        showAlert('Error clearing cache', 'danger');
    });
}

function downloadLogs() {
    window.open('/api/system/download-logs', '_blank');
}
</script>
{% endblock %} 